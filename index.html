<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring-25 Midterm Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Add favicon -->
    <link href="data:image/x-icon;base64,AAABAAEAEBACAAAAAACwAAAAFgAAACgAAAAQAAAAIAAAAAEAAQAAAAAAQAAAAAAAAAAAAAAAAgAAAAAAAAAAAAAA/4QAAMxjAADMYwAA/GMAAMxjAADMawAAMHcAADBjAAAAAAAA+AAAAMBmAADAPAAA+BgAAMAYAADAPAAA+GYAAAAAAAAznAAAM5wAAAOcAAAznAAAM5QAAM+IAADPnAAA//8AAAf/AAA/mQAAP8MAAAfnAAA/5wAAP8MAAAeZAAD//wAA" rel="icon" type="image/x-icon">
    <style>
        /* Toast notification system */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        .toast {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 10px;
            min-width: 280px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transform: translateX(100%);
            animation: slideIn 0.3s forwards, fadeOut 0.5s 3s forwards;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        @keyframes slideIn {
            to { transform: translateX(0); }
        }
        @keyframes fadeOut {
            to { opacity: 0; }
        }
        .success {
            background-color: rgba(52, 211, 153, 0.9);
            color: white;
        }
        .error {
            background-color: rgba(239, 68, 68, 0.9);
            color: white;
        }
        .info {
            background-color: rgba(59, 130, 246, 0.9);
            color: white;
        }
        /* Custom dropdown styling */
        .custom-select {
            position: relative;
        }
        .custom-select .options {
            display: none;
            position: absolute;
            background-color: white;
            max-height: 200px;
            overflow-y: auto;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            width: 100%;
        }
        .custom-select .option {
            padding: 8px 12px;
            cursor: pointer;
        }
        .custom-select .option:hover {
            background-color: #f3f4f6;
        }
        /* Mobile optimizations */
        @media (max-width: 640px) {
            input, button, select {
                font-size: 16px; /* Prevents iOS zoom on focus */
                height: 44px; /* More touch-friendly */
            }
            .table-container {
                margin: 0 -16px; /* Negative margin to allow table to be wider than container on mobile */
            }
        }
        /* Add specific styling for sections datalist */
        .section-input-container {
            position: relative;
            width: 100%;
        }

        /* Footer styling */
        .footer {
            background-color: rgba(30, 58, 138, 0.7);
            padding: 8px 0;
            margin-top: 20px;
            backdrop-filter: blur(5px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .footer a {
            color: #fcd34d; /* Yellow color matching the buttons */
        }
        .footer a:hover {
            color: white;
        }

        /* Add padding to body to prevent footer overlap */
        body {
            padding-bottom: 50px;
        }

        /* Input row styling for all screen sizes */
        .input-row {
            display: flex;
            flex-direction: row;
            width: 100%;
            margin-bottom: 8px;
            gap: 4px; /* Use gap for consistent spacing */
        }
        .input-row .course-code {
            flex: 2;
        }
        .input-row .section {
            flex: 1;
        }
        .input-row .add-course {
            flex: 1;
        }

        /* Dropdown improvements */
        .dropdown {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            z-index: 9999;
            max-height: 12rem;
            overflow-y: auto;
            width: 100%;
            color: #1f2937; /* Add dark text color */
        }
        .dropdown-option {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #1f2937; /* Ensure text is visible */
        }
        .dropdown-option:hover {
            background-color: #fef3c7;
        }
        .dropdown-option.active {
            background-color: #fde68a;
        }
        .dropdown-option.disabled {
            color: #9ca3af;
            cursor: default;
        }
        /* Scrollbar styling */
        .dropdown::-webkit-scrollbar {
            width: 6px;
        }
        .dropdown::-webkit-scrollbar-track {
            background: #f3f4f6;
        }
        .dropdown::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 3px;
        }
    </style>
    <script defer data-domain="bracu-exam-routine.itzmrz.xyz" src="https://plausible.io/js/script.outbound-links.js"></script>
    <script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>
    <script>
  (function() {
    // Detect Facebook/Messenger in-app browsers
    var ua = navigator.userAgent || navigator.vendor || window.opera;
    var isFacebookBrowser = (ua.indexOf("FBAN") > -1) || (ua.indexOf("FBAV") > -1);
    var isMessengerBrowser = (ua.indexOf("MessengerForiOS") > -1) || (ua.indexOf("Messenger") > -1);

    // If detected, redirect to external browser
    if (isFacebookBrowser || isMessengerBrowser) {
      // Get current URL
      var url = window.location.href;

      // Try to force open in external browser
      window.open(url, '_system', 'location=yes');

      // Fallback - suggest copy/paste URL
      setTimeout(function() {
        document.body.innerHTML = '<div style="text-align:center; padding:20px;">' +
          '<h2>For the best experience, please open this page in Chrome or Safari</h2>' +
          '<p>Copy this link and paste in your browser:</p>' +
          '<p><strong>' + url + '</strong></p>' +
          '</div>';
      }, 1000);
    }
  })();
</script>
<style>
    /* Add more padding at the bottom to accommodate the fixed footer */
    body {
        padding-bottom: 120px !important; /* Increased padding for more space */
    }

    /* Create proper spacing for the content area */
    #capture-area {
        margin-bottom: 50px; /* Increased margin */
    }

    /* Ensure screenshot button has space above the footer */
    #screenshot-btn {
        margin-bottom: 80px; /* Increased margin */
    }
</style>
</head>
<body class="bg-black text-white flex flex-col items-center justify-center min-h-screen p-4 sm:p-6" style="background-image: url('https://i.postimg.cc/yWq3K43q/4d4883bf150f7162cc97c2c822f7cb24.jpg'); background-size: cover; background-attachment: fixed;">
    <div id="toast-container" class="toast-container"></div>

    <div id="capture-area" class="flex flex-col items-center w-full max-w-4xl">
        <h1 class="text-3xl font-bold mb-6 text-center">SPRING-25 MIDTERM SCHEDULE</h1>

        <!-- Modified structure for mobile layout -->
        <div id="course-inputs" class="w-full mb-4">
            <!-- Each row contains course code, section, and add button -->
            <div class="input-row">
                <input type="text" placeholder="Course Code" class="course-code bg-white text-gray-800 p-3 rounded mb-2 w-full text-center" autocomplete="off">
                <input type="text" placeholder="Sec" class="section bg-white text-gray-800 p-3 rounded mb-2 w-full text-center" autocomplete="off">
                <button class="add-course bg-yellow-300 text-gray-800 p-3 rounded mb-2 w-full flex items-center justify-center hover:bg-yellow-400 transition">
                    <i class="fas fa-plus mr-2"></i>ADD
                </button>
            </div>
            <div class="input-row">
                <input type="text" placeholder="Course Code" class="course-code bg-white text-gray-800 p-3 rounded mb-2 w-full text-center" autocomplete="off">
                <input type="text" placeholder="Sec" class="section bg-white text-gray-800 p-3 rounded mb-2 w-full text-center" autocomplete="off">
                <button class="add-course bg-yellow-300 text-gray-800 p-3 rounded mb-2 w-full flex items-center justify-center hover:bg-yellow-400 transition">
                    <i class="fas fa-plus mr-2"></i>ADD
                </button>
            </div>
            <div class="input-row">
                <input type="text" placeholder="Course Code" class="course-code bg-white text-gray-800 p-3 rounded mb-2 w-full text-center" autocomplete="off">
                <input type="text" placeholder="Sec" class="section bg-white text-gray-800 p-3 rounded mb-2 w-full text-center" autocomplete="off">
                <button class="add-course bg-yellow-300 text-gray-800 p-3 rounded mb-2 w-full flex items-center justify-center hover:bg-yellow-400 transition">
                    <i class="fas fa-plus mr-2"></i>ADD
                </button>
            </div>
            <div class="input-row">
                <input type="text" placeholder="Course Code" class="course-code bg-white text-gray-800 p-3 rounded mb-2 w-full text-center" autocomplete="off">
                <input type="text" placeholder="Sec" class="section bg-white text-gray-800 p-3 rounded mb-2 w-full text-center" autocomplete="off">
                <button class="add-course bg-yellow-300 text-gray-800 p-3 rounded mb-2 w-full flex items-center justify-center hover:bg-yellow-400 transition">
                    <i class="fas fa-plus mr-2"></i>ADD
                </button>
            </div>
        </div>

        <button id="add-more-btn" class="bg-yellow-300 text-gray-800 p-3 rounded mb-6 w-full max-w-xs sm:w-auto sm:px-6 hover:bg-yellow-400 transition">+ Add More</button>

        <div class="w-full overflow-x-auto table-container">
            <table id="exam-schedule" class="min-w-full bg-opacity-70 bg-black border border-white text-center">
                <thead>
                    <tr class="border-b border-white">
                        <th class="px-3 py-3 text-center">Date</th>
                        <th class="px-3 py-3 text-center">Time</th>
                        <th class="px-3 py-3 text-center">Course</th>
                        <th class="px-3 py-3 text-center">Section</th>
                        <th class="px-3 py-3 text-center">Classroom</th>
                    </tr>
                </thead>
                <tbody id="schedule-body">
                    <!-- Exam schedule rows will be added here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <button id="screenshot-btn" class="bg-yellow-300 text-gray-800 p-3 rounded mt-6 w-full max-w-xs sm:w-auto sm:px-6 flex items-center justify-center hover:bg-yellow-400 transition">
        <i class="fas fa-camera mr-2"></i>Screenshot
    </button>

    <!-- Add the footer -->
    <footer class="text-center fixed bottom-0 left-0 right-0 shadow-lg footer">
        <a href="https://github.com/itzMRZ" class="flex items-center justify-center gap-2 text-sm font-bold transition-colors duration-300">
          <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
            <path fill-rule="evenodd"
                  d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"
                  clip-rule="evenodd"/>
          </svg>
          By MRZ
        </a>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set up toast notification container
            const toastContainer = document.getElementById('toast-container');

            // Load schedule data
            loadScheduleData().then(() => {
                // Load cached courses after exam data is loaded
                const cachedCourses = loadFromCache();
                if (cachedCourses.length > 0) {
                    cachedCourses.forEach(course => {
                        const matchingExams = examData.filter(exam =>
                            exam.courseCode.toLowerCase() === course.courseCode.toLowerCase() &&
                            exam.section === course.section
                        );
                        if (matchingExams.length > 0) {
                            addExamsToSchedule(matchingExams);
                        }
                    });
                    showToast(`Loaded ${cachedCourses.length} courses from cache`, 'info');
                }
            });

            // Add event listeners
            setupEventListeners();
        });

        // Store the exam data and course information globally
        let examData = [];
        let availableCourses = new Set();
        let isFinalsSchedule = false; // Track if we're showing finals or midterms

        // Course to sections mapping for quick lookups
        let courseSections = {};

        // Cache functions for user input
        const CACHE_KEY = 'examScheduleCache';
        const CACHE_EXPIRY = 72 * 60 * 60 * 1000; // 72 hours in milliseconds

        function saveToCache(courseCode, section) {
            const now = new Date().getTime();
            let cache = JSON.parse(localStorage.getItem(CACHE_KEY) || '{"courses":[],"timestamp":0}');

            // Check if cache has expired
            if (now - cache.timestamp > CACHE_EXPIRY) {
                cache = { courses: [], timestamp: now };
            }

            // Add new course if it doesn't exist
            if (!cache.courses.some(c => c.courseCode === courseCode && c.section === section)) {
                cache.courses.push({ courseCode, section });
                localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
            }
        }

        function loadFromCache() {
            const now = new Date().getTime();
            const cache = JSON.parse(localStorage.getItem(CACHE_KEY) || '{"courses":[],"timestamp":0}');

            // Return empty array if cache has expired
            if (now - cache.timestamp > CACHE_EXPIRY) {
                localStorage.removeItem(CACHE_KEY);
                return [];
            }

            return cache.courses;
        }

        function clearCache() {
            localStorage.removeItem(CACHE_KEY);
        }

        function updateTitle() {
            const examType = isFinalsSchedule ? "FINAL" : "MIDTERM";
            document.querySelector('h1').textContent = `SPRING-25 ${examType} SCHEDULE`;
            document.title = `Spring-25 ${examType} Schedule`;
        }

        function loadScheduleData() {
            console.log("Fetching exam data...");
            fetch('exam_data.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Determine if this is finals schedule by checking first exam
                    if (data.exams && data.exams.length > 0) {
                        isFinalsSchedule = 'Final Date' in data.exams[0];
                        updateTitle();
                    }

                    // Filter out entries that don't have all required fields
                    examData = data.exams
                        .filter(exam => exam["Course"] && exam["Section"] &&
                               (exam["Mid Date"] || exam["Final Date"]) &&
                               exam["Start Time"] && exam["End Time"] && exam["Room."])
                        .map(exam => {
                            const courseCode = exam["Course"];
                            const section = exam["Section"];
                            const dateField = exam["Final Date"] ? "Final Date" : "Mid Date";

                            // Collect unique course codes for suggestions
                            availableCourses.add(courseCode);

                            // Build course to sections mapping
                            if (!courseSections[courseCode]) {
                                courseSections[courseCode] = new Set();
                            }
                            courseSections[courseCode].add(section);

                            return {
                                date: formatDateFromJSON(exam[dateField]),
                                time: convertTimeFromJSON(exam["Start Time"], exam["End Time"]),
                                courseCode: courseCode,
                                section: section,
                                classroom: exam["Room."]
                            };
                        });

                    console.log("Loaded exam data:", examData.length, "entries");

                    // Initialize course suggestions
                    initializeCourseSuggestions();

                    // Show success message
                    showToast(`Loaded ${examData.length} exam entries successfully`, 'success');
                })
                .catch(error => {
                    console.error('Error loading schedule data:', error);
                    showToast('Error loading schedule data. Please refresh the page.', 'error');
                });
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;

            // Add to container
            const container = document.getElementById('toast-container');
            container.appendChild(toast);

            // Remove after animation
            toast.addEventListener('animationend', (e) => {
                if (e.animationName === 'fadeOut') {
                    container.removeChild(toast);
                }
            });
        }

        // Initialize course input fields with suggestions
        function initializeCourseSuggestions() {
            const debouncedShowCourseDropdown = debounce((input, index) => {
                showCourseDropdown(input, index);
            }, 150);

            const debouncedShowSectionDropdown = debounce((input, index) => {
                showSectionDropdown(input, index);
            }, 150);

            document.querySelectorAll('.course-code').forEach((input, index) => {
                input.addEventListener('focus', () => showCourseDropdown(input, index));
                input.addEventListener('input', () => debouncedShowCourseDropdown(input, index));
            });

            document.querySelectorAll('.section').forEach((input, index) => {
                input.addEventListener('focus', () => showSectionDropdown(input, index));
                input.addEventListener('input', () => debouncedShowSectionDropdown(input, index));
            });
        }

        // Debounce function to prevent too many updates
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function showCourseDropdown(input, index) {
            hideAllDropdowns();

            const inputRect = input.getBoundingClientRect();
            const scrollY = window.scrollY;

            const dropdown = document.createElement('div');
            dropdown.className = 'dropdown';
            dropdown.id = `course-dropdown-${index}`;
            dropdown.setAttribute('role', 'listbox');
            dropdown.style.minWidth = '200px';

            const filter = input.value.trim().toLowerCase();
            let filtered = Array.from(availableCourses)
                .filter(course => course.toLowerCase().includes(filter));

            if (filtered.length === 0) {
                const noOpt = document.createElement('div');
                noOpt.className = 'dropdown-option disabled';
                noOpt.textContent = 'No match';
                dropdown.appendChild(noOpt);
            } else {
                filtered.sort().forEach((course, optionIndex) => {
                    const option = document.createElement('div');
                    option.className = 'dropdown-option';
                    option.setAttribute('role', 'option');
                    option.setAttribute('tabindex', '-1');
                    option.setAttribute('data-index', optionIndex.toString());
                    option.textContent = course;

                    option.addEventListener('mouseenter', () => {
                        dropdown.querySelectorAll('.dropdown-option').forEach(opt =>
                            opt.classList.remove('active'));
                        option.classList.add('active');
                    });

                    option.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        selectCourse(input, course, index);
                    });

                    dropdown.appendChild(option);
                });
            }

            document.body.appendChild(dropdown);
            positionDropdown(dropdown, input);
            setupKeyboardNav(dropdown, input, index, 'course');
        }

        function showSectionDropdown(input, index) {
            hideAllDropdowns();

            const courseInput = document.querySelectorAll('.course-code')[index];
            const courseCode = courseInput.value.trim();

            const dropdown = document.createElement('div');
            dropdown.className = 'dropdown';
            dropdown.id = `section-dropdown-${index}`;
            dropdown.setAttribute('role', 'listbox');
            dropdown.style.minWidth = '100px';

            let filtered = [];
            if (courseCode && courseSections[courseCode]) {
                filtered = Array.from(courseSections[courseCode]);
                const filter = input.value.trim().toLowerCase();
                filtered = filtered.filter(section =>
                    section.toLowerCase().includes(filter));
            }

            if (filtered.length === 0) {
                const noOpt = document.createElement('div');
                noOpt.className = 'dropdown-option disabled';
                noOpt.textContent = courseCode ? 'No sections found' : 'Select a course first';
                dropdown.appendChild(noOpt);
            } else {
                filtered
                    .sort((a, b) => (parseInt(a, 10) || 0) - (parseInt(b, 10) || 0))
                    .forEach((section, optionIndex) => {
                        const option = document.createElement('div');
                        option.className = 'dropdown-option';
                        option.setAttribute('role', 'option');
                        option.setAttribute('tabindex', '-1');
                        option.setAttribute('data-index', optionIndex.toString());
                        option.textContent = section;

                        option.addEventListener('mouseenter', () => {
                            dropdown.querySelectorAll('.dropdown-option').forEach(opt =>
                                opt.classList.remove('active'));
                            option.classList.add('active');
                        });

                        option.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            selectSection(input, section, index);
                        });

                        dropdown.appendChild(option);
                    });
            }

            document.body.appendChild(dropdown);
            positionDropdown(dropdown, input);
            setupKeyboardNav(dropdown, input, index, 'section');
        }

        function positionDropdown(dropdown, input) {
            const inputRect = input.getBoundingClientRect();
            const scrollY = window.scrollY;
            const viewportHeight = window.innerHeight;

            // Position horizontally
            dropdown.style.left = inputRect.left + 'px';
            dropdown.style.width = inputRect.width + 'px';

            // Check if there's room below
            const spaceBelow = viewportHeight - inputRect.bottom;
            const spaceAbove = inputRect.top;
            const dropdownHeight = dropdown.offsetHeight;

            if (spaceBelow >= dropdownHeight || spaceBelow >= spaceAbove) {
                // Position below
                dropdown.style.top = (inputRect.bottom + scrollY) + 'px';
            } else {
                // Position above
                dropdown.style.top = (inputRect.top + scrollY - dropdownHeight) + 'px';
            }
        }

        function setupKeyboardNav(dropdown, input, index, type) {
            const options = Array.from(dropdown.querySelectorAll('.dropdown-option:not(.disabled)'));
            let activeIndex = -1;

            input.addEventListener('keydown', function(e) {
                switch(e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        activeIndex = Math.min(activeIndex + 1, options.length - 1);
                        updateActiveOption();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        activeIndex = Math.max(activeIndex - 1, 0);
                        updateActiveOption();
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (activeIndex >= 0) {
                            const selectedOption = options[activeIndex];
                            if (type === 'course') {
                                selectCourse(input, selectedOption.textContent, index);
                            } else {
                                selectSection(input, selectedOption.textContent, index);
                            }
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        hideAllDropdowns();
                        input.blur();
                        break;
                }
            });

            function updateActiveOption() {
                options.forEach(opt => opt.classList.remove('active'));
                if (activeIndex >= 0) {
                    options[activeIndex].classList.add('active');
                    options[activeIndex].scrollIntoView({ block: 'nearest' });
                }
            }
        }

        function selectCourse(input, course, index) {
            input.value = course;
            hideAllDropdowns();
            updateSectionOptions(index);
            // Focus the section input
            const sectionInput = document.querySelectorAll('.section')[index];
            sectionInput.focus();
            showSectionDropdown(sectionInput, index);
        }

        function selectSection(input, section, index) {
            input.value = section;
            hideAllDropdowns();
            // Focus the add button
            const addButton = input.closest('.input-row').querySelector('.add-course');
            addButton.focus();
        }

        function hideAllDropdowns() {
            document.querySelectorAll('.dropdown').forEach(dropdown => dropdown.remove());
        }

        // Click outside handler
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.course-code') && !e.target.closest('.section')) {
                hideAllDropdowns();
            }
        });

        // Update scroll handler
        window.addEventListener('scroll', debounce(() => {
            const activeDropdown = document.querySelector('.dropdown');
            if (activeDropdown) {
                const input = document.activeElement;
                if (input && (input.classList.contains('course-code') || input.classList.contains('section'))) {
                    positionDropdown(activeDropdown, input);
                }
            }
        }, 100), { passive: true });

        // Helper function to format date from "YYYY-MM-DD" to "D-MMM-YY"
        function formatDateFromJSON(dateStr) {
            // Accepts formats like "20-May-25" or "2025-05-20"
            if (!dateStr) return '';
            // Try to parse D-MMM-YY
            const dmy = /^([0-9]{1,2})-([A-Za-z]{3})-([0-9]{2,4})$/;
            const ymd = /^([0-9]{4})-([0-9]{2})-([0-9]{2})$/;
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            let day, month, year;
            if (dmy.test(dateStr)) {
                const match = dmy.exec(dateStr);
                day = parseInt(match[1], 10);
                month = monthNames.indexOf(match[2]);
                year = parseInt(match[3], 10);
                if (year < 100) year += 2000;
                return `${day}-${monthNames[month]}-${String(year).slice(-2)}`;
            } else if (ymd.test(dateStr)) {
                const match = ymd.exec(dateStr);
                year = parseInt(match[1], 10);
                month = parseInt(match[2], 10) - 1;
                day = parseInt(match[3], 10);
                return `${day}-${monthNames[month]}-${String(year).slice(-2)}`;
            }
            return dateStr;
        }

        // Helper function to convert 24-hour time to "h:mm AM/PM"
        function convertToAMPM(timeString) {
            const [hourStr, minuteStr] = timeString.split(':');
            let hour = parseInt(hourStr, 10);
            const minute = parseInt(minuteStr, 10);
            const ampm = hour >= 12 ? "PM" : "AM";
            hour = hour % 12;
            if (hour === 0) hour = 12;
            return `${hour}:${minute.toString().padStart(2, '0')} ${ampm}`;
        }

        // Helper function to convert start and end times from JSON to the desired format
        function convertTimeFromJSON(startTime, endTime) {
            return `${convertToAMPM(startTime)} - ${convertToAMPM(endTime)}`;
        }

        function populateExamSchedule(exams) {
            console.log("Populating exam schedule with", exams.length, "exams");
            const scheduleBody = document.getElementById('schedule-body');

            if (!scheduleBody) {
                console.error("Could not find schedule-body element!");
                return;
            }

            // Sort exams by date and time
            exams.sort((a, b) => {
                const dateCompare = new Date(convertDate(a.date)) - new Date(convertDate(b.date));
                if (dateCompare !== 0) return dateCompare;

                // If same date, compare times
                return convertTimeToMinutes(a.time.split(' - ')[0]) - convertTimeToMinutes(b.time.split(' - ')[0]);
            });

            // Add each exam to the table
            exams.forEach(exam => {
                // Check if this exam is already in the table to avoid duplicates
                const existingRows = Array.from(scheduleBody.querySelectorAll('tr')).filter(row => {
                    return row.cells[2].textContent === exam.courseCode &&
                           row.cells[3].textContent === exam.section;
                });

                if (existingRows.length === 0) {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-white hover:bg-blue-800 transition';

                    // Create row cells
                    row.innerHTML = `
                        <td class="px-3 py-3">${exam.date}</td>
                        <td class="px-3 py-3">${exam.time}</td>
                        <td class="px-3 py-3">${exam.courseCode}</td>
                        <td class="px-3 py-3">${exam.section}</td>
                        <td class="px-3 py-3">${exam.classroom}</td>
                    `;

                    scheduleBody.appendChild(row);
                }
            });
        }

        function setupEventListeners() {
            // Add more button
            document.getElementById('add-more-btn').addEventListener('click', function() {
                addMoreInputs();
            });

            // Screenshot button
            document.getElementById('screenshot-btn').addEventListener('click', function() {
                takeScreenshot();
            });

            // Add course buttons
            document.querySelectorAll('.add-course').forEach((button, index) => {
                button.addEventListener('click', function() {
                    addCourseFromInput(index);
                });
            });
        }

        // Function to handle adding courses from input fields
        function addCourseFromInput(index) {
            const courseCode = document.querySelectorAll('.course-code')[index].value;
            const section = document.querySelectorAll('.section')[index].value;

            console.log(`Trying to add course: ${courseCode} Section: ${section}`);

            if (courseCode && section) {
                // Find matching exams in the JSON data
                const matchingExams = examData.filter(exam =>
                    exam.courseCode.toLowerCase() === courseCode.toLowerCase() &&
                    exam.section === section
                );

                console.log(`Found ${matchingExams.length} matching exams`);

                if (matchingExams.length > 0) {
                    // Add matching exams to the schedule
                    addExamsToSchedule(matchingExams);
                    // Save to cache
                    saveToCache(courseCode, section);
                    showToast(`Added ${courseCode} Section ${section} to exam schedule`, 'success');
                } else {
                    showToast(`No exam found for ${courseCode} Section ${section}`, 'error');
                }
            } else {
                showToast('Please enter both course code and section', 'error');
            }
        }

        function addExamsToSchedule(exams) {
            console.log("Adding exams to schedule");
            // Add the exams to the schedule
            populateExamSchedule(exams);

            // Resort the table
            sortScheduleTable();
        }

        function addMoreInputs() {
            // Get the container and count existing rows
            const courseInputsContainer = document.getElementById('course-inputs');
            const currentRowCount = courseInputsContainer.querySelectorAll('.input-row').length;

            // Check if we've reached the maximum allowed rows (7)
            if (currentRowCount >= 7) {
                showToast('Maximum of 7 course inputs allowed', 'info');
                return;
            }

            // Create new row
            const newRow = document.createElement('div');
            newRow.className = 'input-row';

            // Row index for this new row
            const rowIndex = currentRowCount;

            // Create HTML for the new row with all elements
            newRow.innerHTML = `
                <input type="text" placeholder="Course Code" class="course-code bg-white text-gray-800 p-3 rounded mb-2 w-full text-center" autocomplete="off">
                <input type="text" placeholder="Sec" class="section bg-white text-gray-800 p-3 rounded mb-2 w-full text-center" autocomplete="off">
                <button class="add-course bg-yellow-300 text-gray-800 p-3 rounded mb-2 w-full flex items-center justify-center hover:bg-yellow-400 transition">
                    <i class="fas fa-plus mr-2"></i>ADD
                </button>
            `;

            // Append the new row to the container
            courseInputsContainer.appendChild(newRow);

            // Set up course suggestions for the new inputs
            const newCourseInput = newRow.querySelector('.course-code');
            const newSectionInput = newRow.querySelector('.section');

            // Connect course input to datalist
            newCourseInput.setAttribute('list', 'course-suggestions');

            // Create section datalist
            const datalistId = `section-suggestions-${rowIndex}`;
            let sectionDatalist = document.getElementById(datalistId);

            if (!sectionDatalist) {
                sectionDatalist = document.createElement('datalist');
                sectionDatalist.id = datalistId;
                document.body.appendChild(sectionDatalist);
            }

            // Connect section input to its datalist
            newSectionInput.setAttribute('list', datalistId);

            // Add event listeners
            newCourseInput.addEventListener('input', function() {
                updateSectionOptions(rowIndex);
            });

            newRow.querySelector('.add-course').addEventListener('click', function() {
                addCourseFromInput(rowIndex);
            });
        }

        function takeScreenshot() {
            // Check if table has content
            if (document.getElementById('schedule-body').children.length === 0) {
                showToast('No exams to screenshot. Please add courses first.', 'error');
                return;
            }

            // Create a temporary container that includes only what we want in the screenshot
            const tempContainer = document.createElement('div');
            tempContainer.className = 'bg-black p-6 rounded';

            // Add the title
            const title = document.createElement('h1');
            title.className = 'text-2xl font-bold mb-6 text-white text-center';
            title.textContent = document.querySelector('h1').textContent;
            tempContainer.appendChild(title);

            // Clone the table and add custom styles for screenshot
            const tableElement = document.getElementById('exam-schedule');
            const tableClone = tableElement.cloneNode(true);
            tableClone.className = 'min-w-full bg-opacity-70 bg-black border border-white text-center';
            tempContainer.appendChild(tableClone);

            // Temporarily add to document but hide it
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            document.body.appendChild(tempContainer);

            // Take screenshot of the temporary element
            html2canvas(tempContainer, {
                backgroundColor: 'rgba(0, 0, 0, 0.9)'
            }).then(canvas => {
                // Create download link
                const link = document.createElement('a');
                link.download = 'Spring25-Midterm-Schedule.png';
                link.href = canvas.toDataURL('image/png');
                link.click();

                // Clean up
                document.body.removeChild(tempContainer);

                // Show success message
                showToast('Schedule screenshot saved!', 'success');
            }).catch(error => {
                console.error('Screenshot error:', error);
                showToast('Error taking screenshot. Please try again.', 'error');
                document.body.removeChild(tempContainer);
            });
        }

        function convertDate(dateStr) {
            // Convert date strings like "18-Mar-25" to "2025-03-18" for proper sorting
            const parts = dateStr.split('-');
            const month = {
                'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04', 'May': '05', 'Jun': '06',
                'Jul': '07', 'Aug': '08', 'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
            };
            return `20${parts[2]}-${month[parts[1]]}-${parts[0].padStart(2, '0')}`;
        }

        function convertTimeToMinutes(timeStr) {
            // Convert time strings like "12:00 PM" to minutes for sorting
            const [time, period] = timeStr.split(' ');
            let [hours, minutes] = time.split(':').map(Number);

            if (period === 'PM' && hours !== 12) {
                hours += 12;
            } else if (period === 'AM' && hours === 12) {
                hours = 0;
            }

            return hours * 60 + minutes;
        }

        function sortScheduleTable() {
            const scheduleBody = document.getElementById('schedule-body');
            if (!scheduleBody) return;

            const rows = Array.from(scheduleBody.querySelectorAll('tr'));
            if (rows.length <= 1) return;

            // Sort rows
            rows.sort((a, b) => {
                const dateA = a.cells[0].textContent;
                const dateB = b.cells[0].textContent;
                const dateCompare = new Date(convertDate(dateA)) - new Date(convertDate(dateB));

                if (dateCompare !== 0) return dateCompare;

                // If same date, compare times
                const timeA = a.cells[1].textContent.split(' - ')[0];
                const timeB = b.cells[1].textContent.split(' - ')[0];
                return convertTimeToMinutes(timeA) - convertTimeToMinutes(timeB);
            });

            // Clear and reappend sorted rows
            while (scheduleBody.firstChild) {
                scheduleBody.removeChild(scheduleBody.firstChild);
            }

            // Reappend sorted rows
            rows.forEach(row => scheduleBody.appendChild(row));
        }
    </script>

</body>
</html>